name: Run-Data-Pipeline

on:
    push:
        branches-ignore:
            - "master"

jobs:
    run-pipeline:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v2
            - name: Install data pipeline
              run: |
                sudo apt install python3.8
                python3.8 -m pip install setuptools
                python3.8 -m pip install git+https://github.com/ddionrails/paneldata_pipeline@master#egg=paneldata_pipeline
            - name: Process Data
              run: |
                python3.8 -m paneldata_pipeline -i metadata/ -o ddionrails/ -s soep-core-preview -w ${{ secrets.study_version }} -g -u -r -q
            - name: Install data compliance check
              run: |
                python3 -m pip install setuptools
                python3 -m pip install goodtables
            - name: Test
              run: |
                python3 -m goodtables ddionrails/datapackage.json

            - name: Update file and push to remote
              run: |
                git ls-files --others --exclude-standard | xargs git add
                CHANGES_TO_COMMIT=$(git diff-index --name-only HEAD | wc -w)
                if [ "$CHANGES_TO_COMMIT" -gt 1 ]
                then 
                  git config --global user.name "GitHub Action"
                  git config --global user.email "github-actions@users.noreply.github.com"

                  git add -A
                  git commit -m "Update generated data with data-pipeline"
                  git push
                else
                  exit 0
                fi
